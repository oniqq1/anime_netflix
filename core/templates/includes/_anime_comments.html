<div class="max-w-[80rem] mx-auto mt-12 md:mt-24 mb-16 md:mb-32 px-3 md:px-6">
  <div class="bg-zinc-800/80 rounded-xl p-4 md:p-8">
    <h3 class="text-2xl md:text-3xl font-bold mb-4 md:mb-6">Комментарии</h3>

    {% if user.is_authenticated %}
      <form method="POST" class="mb-6 md:mb-10">
        {% csrf_token %}
        <textarea name="comment" rows="3" placeholder="Написать комментарий..." class="w-full bg-zinc-900 text-white rounded-lg p-3 md:p-4 text-sm md:text-base focus:outline-none focus:ring-2 focus:ring-red-500 resize-none" required></textarea>
        <button type="submit" class="mt-3 md:mt-4 px-4 md:px-6 py-2 bg-red-600 hover:bg-red-700 transition rounded-lg font-medium text-sm md:text-base">
          Отправить
        </button>
      </form>
    {% else %}
      <div class="mb-6 md:mb-8 p-3 md:p-4 bg-zinc-900 rounded-lg text-center text-zinc-400 text-sm md:text-base">
        Чтобы оставить комментарий войдите в аккаунт
      </div>
    {% endif %}

    <div class="space-y-4 md:space-y-6">
      {% for comment in comments %}
        <div class="bg-zinc-900 p-4 md:p-6 rounded-xl border border-zinc-800 hover:border-zinc-700 transition-colors">
          <div class="flex items-start justify-between mb-3 gap-3">
            <div class="flex items-center gap-3 min-w-0 flex-1">
              {% if comment.user.profile.avatar %}
                <img src="{{ comment.user.profile.avatar.url }}" alt="Avatar"
                     class="w-10 h-10 md:w-12 md:h-12 rounded-full object-cover ring-2 ring-yellow-400/50 flex-shrink-0">
              {% else %}
                <div class="w-10 h-10 md:w-12 md:h-12 rounded-full bg-gradient-to-br from-zinc-700 to-zinc-800 flex items-center justify-center text-base md:text-lg font-bold ring-2 ring-zinc-700 flex-shrink-0">
                  {{ comment.user.username|first|upper }}
                </div>
              {% endif %}
              <div class="min-w-0 flex-1">
                <div class="font-bold text-red-500 text-base md:text-lg truncate">
                  {{ comment.user.profile.nickname|default:comment.user.username }}
                </div>
              </div>
            </div>
            <span class="text-xs md:text-sm text-zinc-500 whitespace-nowrap flex-shrink-0">
              {{ comment.created_at|date:"d.m.Y H:i" }}
            </span>
          </div>
          <p class="text-zinc-300 whitespace-pre-line text-sm md:text-base leading-relaxed pl-0 md:pl-15 break-words hyphens-auto overflow-hidden">
            {{ comment.text }}
          </p>
          
          {% if user.is_authenticated %}
          <div class="flex items-center gap-4 mt-3">
            <button type="button" onclick="likeComment({{ comment.id }}, true)" class="flex items-center gap-1 text-xs md:text-sm text-zinc-400 hover:text-green-400 transition">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
              </svg>
              <span id="likes-{{ comment.id }}">{{ comment.likes_count }}</span>
            </button>
            <button type="button" onclick="likeComment({{ comment.id }}, false)" class="flex items-center gap-1 text-xs md:text-sm text-zinc-400 hover:text-red-400 transition">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.736 3h4.018a2 2 0 01.485.06l3.76.94m-7 10v5a2 2 0 002 2h.096c.5 0 .905-.405.905-.904 0-.715.211-1.413.608-2.008L17 13V4m-7 10h2m5-10h2a2 2 0 012 2v6a2 2 0 01-2 2h-2.5"/>
              </svg>
              <span id="dislikes-{{ comment.id }}">{{ comment.dislikes_count }}</span>
            </button>
            <span class="text-xs md:text-sm text-zinc-500">
              Рейтинг: <span id="rating-{{ comment.id }}">{{ comment.rating }}</span>
            </span>
          </div>
          {% endif %}
        </div>
      {% empty %}
        <div class="text-center text-zinc-500">
          Пока нет комментариев
        </div>
      {% endfor %}
    </div>
  </div>

  {% if comments.has_other_pages %}
  <div class="mt-6 md:mt-10 flex justify-center items-center gap-2 md:gap-4 flex-wrap">
      {% if comments.has_previous %}
          <a href="?page={{ comments.previous_page_number }}" class="px-3 md:px-4 py-2 bg-zinc-700 rounded-lg hover:bg-zinc-600 transition text-sm md:text-base">← Назад</a>
      {% endif %}

      <span class="text-zinc-400 text-sm md:text-base">
          Страница {{ comments.number }} из {{ comments.paginator.num_pages }}
      </span>

      {% if comments.has_next %}
      <a href="?page={{ comments.next_page_number }}" class="px-3 md:px-4 py-2 bg-zinc-700 rounded-lg hover:bg-zinc-600 transition text-sm md:text-base">Далее →</a>
      {% endif %}

  </div>
  {% endif %}
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function likeComment(commentId, isLike) {
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/comment/${commentId}/like/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrftoken
        },
        body: `is_like=${isLike}`
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById(`likes-${commentId}`).textContent = data.likes;
        document.getElementById(`dislikes-${commentId}`).textContent = data.dislikes;
        document.getElementById(`rating-${commentId}`).textContent = data.rating;
    })
    .catch(error => console.error('Error:', error));
}
</script>
